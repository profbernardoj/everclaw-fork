# 2026-02-14

## Venice Billing Backoff Config Fix (22:00 CST)

Applied immediate config patch to reduce Venice billing backoff:
```json
{
  "auth": {
    "cooldowns": {
      "billingBackoffHoursByProvider": { "venice": 1 },
      "billingMaxHours": 6,
      "failureWindowHours": 12
    }
  }
}
```
- Venice billing backoff: 5h → 1h (keys retried hourly instead of every 5h)
- Billing max cap: 24h → 6h
- Failure window: 24h → 12h
- Gateway restarted via SIGUSR1 after patch

## Feb 13 Outage Root Cause (from previous session analysis)

### Timeline
- ~4:04 AM: First billing error — overnight research sub-agents (13 tasks from Feb 12) burning DIEM
- ~11:29 AM: Guardian caught stuck sub-agent, restarted. Brief recovery.
- ~4:29 PM: Inference fails again — billing cascade across ALL providers
- 4:33–4:54 PM: Guardian escalates 13 times — zero restart logs. Dead loop.
- ~6:00 PM: DIEM resets at midnight UTC → natural recovery

### Bug 1: Billing backoff death spiral
- 402 on key1 → 5h disable. Keys 2-6 already disabled. Morpheus in cooldown.
- 50 DIEM on key1 not enough for Claude Opus 4.6 (30-50+ DIEM per request with full context)
- Restarting clears cooldown but first request immediately re-triggers 402 → re-disabled
- **Fix applied:** Reduced backoff to 1h via config patch

### Bug 2: Guardian restart chain silently fails
- `set -euo pipefail` causes silent exit when `openclaw gateway restart` returns non-zero
- `pkill -9 -f "openclaw.*gateway"` matches Guardian's own process (self-kill)
- **Fix needed:** Guardian v4 rewrite

### Guardian v4 Plan (NOT YET BUILT)
1. ✅ Config fix — billing backoff reduced (done)
2. Billing-aware escalation — classify errors, don't restart for billing, calculate time to midnight UTC
3. Fix silent restart — `set -uo pipefail` + ERR trap, exclude own PID from pkill
4. Cheaper model fallback — try kimi on same key before disabling profile
5. Proactive credit monitoring — check Venice credits periodically, warn before exhaustion

### Guardian Log Evidence
- 4:29 PM onwards: `WARN: Inference probe failed ... unknown: {` (13 consecutive)
- Each said "Escalating..." but zero "Step 1:" or "RECOVERED" lines
- Circuit breaker fired twice for stuck run `3ef4dda8`
- Recovery at ~6:00 PM when DIEM reset at midnight UTC

## Still TODO
- ~~Build Guardian v4 with billing-aware logic~~ ✅ DONE
- ~~Update Everclaw skill docs for v4~~ ✅ DONE
- David's pending items from Feb 12 (Morpheus/BasedAI variants, SmartAgent PR #3, etc.)

## Gateway Guardian v4 — Shipped (23:14 CST)

Full v4 rewrite of `scripts/gateway-guardian.sh` (502 lines). All 5 pieces landed in one write:

### Changes
1. **Silent restart fix** — `set -uo pipefail` + ERR trap (no more `set -e` silent exits). Explicit exit code capture in `do_graceful_restart` and `do_nuclear_reinstall`.
2. **pkill self-kill fix** — `GUARDIAN_PID=$$`, hard restart loop excludes own PID.
3. **Billing-aware escalation** — `classify_error()` parses billing/transient/timeout. `handle_billing_exhaustion()` calculates hours to midnight UTC, enters 30-min backoff instead of restarting.
4. **Signal notifications** — Notifies David on: billing exhaustion (with DIEM reset ETA), billing recovery, nuclear restart, total failure.
5. **Billing backoff gate** — Top of script checks if billing-dead. Skips probes for 30 min. Auto-clears when UTC day rolls over.

### Verified
- `bash -n` syntax check: PASS
- `--verbose` live test: `OK: Fully healthy (PID=?, HTTP=200, inference=ok)`
- Committed to workspace repo + pushed everclaw to GitHub

### Docs Updated (23:29 CST)
- **Everclaw:** README.md, docs/index.html, website/index.html — all v3 → v4 references updated. Pushed to `profbernardoj/everclaw` main.
- **SmartAgent:** README.md + docs/index.html architecture diagrams updated v3 → v4. PR #5 created: https://github.com/SmartAgentProtocol/smartagent/pull/5 (needs David's merge).
- **SKILL.md section 14** already had comprehensive v4 docs from earlier in the session.

## Session Notes
- Session hit 109% context (221k tokens) before compaction. Claude Opus 4.6 at $6/$30/M = expensive.
- David requested breaking work into small pieces after a monolithic attempt stalled. The full v4 write actually succeeded on the second attempt.
- Valentine's evening — David was efficient and decisive ("go for it", "yes move on").
